# Контейнеризация с Docker

## Содержание
- [Что такое Docker и контейнеризация?](#что-такое-docker-и-контейнеризация)
- [Архитектура и компоненты Docker](#архитектура-и-компоненты-docker)
- [Основные объекты Docker](#основные-объекты-docker)
- [Dockerfile: Сборка собственных образов](#dockerfile-сборка-собственных-образов)
- [Запуск тестов в Docker-контейнере](#запуск-тестов-в-docker-контейнере)
- [Оптимизация и лучшие практики](#оптимизация-и-лучшие-практики)
- [Установка Docker](#установка-docker)
- [Полезные ресурсы](#полезные-ресурсы)

## Что такое Docker и контейнеризация?

**Контейнеризация** — это метод виртуализации, при котором приложение и его зависимости упаковываются в изолированную среду, называемую **контейнером**. Это гарантирует, что приложение будет работать одинаково в любом окружении.

**Docker** — это открытая платформа для разработки, доставки и запуска приложений в контейнерах. Она решает проблему "на моей машине все работает", обеспечивая консистентность окружения от разработки до продакшена.

## Архитектура и компоненты Docker

-   **Docker Engine**: Приложение клиент-серверного типа, которое является ядром Docker. Состоит из:
    -   **Сервера (Docker Daemon)**: Фоновый процесс (`dockerd`), который управляет объектами Docker (образами, контейнерами, сетями, томами).
    -   **REST API**: Интерфейс, который программы используют для взаимодействия с демоном.
    -   **CLI (Command Line Interface)**: Консольный клиент (`docker`), который позволяет пользователям управлять Docker с помощью команд.
-   **Docker Desktop**: Приложение для Windows и macOS, которое упрощает установку и управление Docker в локальной среде. Включает Docker Engine, CLI и графический интерфейс (Dashboard).
-   **Docker Hub**: Публичный реестр (хранилище) Docker-образов по умолчанию. Содержит тысячи готовых образов для различных технологий.

## Основные объекты Docker

-   **Образ (Image)**: Шаблон только для чтения, содержащий инструкции для создания контейнера. Образы состоят из слоев, где каждый слой представляет собой изменение файловой системы. Описание слоев хранится в `Dockerfile`.
-   **Контейнер (Container)**: Запущенный экземпляр образа. Он изолирован от хост-системы и других контейнеров, но может взаимодействовать с ними через сети.
-   **Том (Volume)**: Механизм для сохранения данных, генерируемых и используемых контейнерами. Тома хранятся на хост-машине и позволяют данным "пережить" удаление контейнера.
-   **Сеть (Network)**: Позволяет контейнерам общаться друг с другом и с внешним миром. Docker поддерживает несколько типов сетей, например `bridge` (по умолчанию) и `host`.

## Dockerfile: Сборка собственных образов

`Dockerfile` — это текстовый файл, который содержит последовательность команд для автоматической сборки Docker-образа.

**Пример `Dockerfile` для Node.js приложения:**

```dockerfile
# 1. Указываем базовый образ, с которого начинаем сборку
FROM node:20

# 2. Устанавливаем рабочую директорию внутри контейнера
WORKDIR /app

# 3. Копируем файлы package.json и package-lock.json
# Это делается отдельно для использования кеша слоев Docker.
# Слой пересоздастся только если эти файлы изменятся.
COPY package*.json ./

# 4. Устанавливаем зависимости
RUN npm ci

# 5. Копируем остальные файлы проекта в рабочую директорию
COPY . .

# 6. Команда, которая будет выполнена при запуске контейнера (опционально)
CMD [ "npm", "test" ]
```

**Сборка образа:**
```bash
# -t (tag) задает имя и тег для образа
docker build -t otus-qajs .
```

## Запуск тестов в Docker-контейнере

### Способ 1: Запуск из собранного образа
Этот способ использует образ, в который уже упакованы все зависимости и исходный код. Идеально для CI/CD.

```bash
docker run otus-qajs
# Если в Dockerfile указан CMD, команда `npm test` запустится автоматически
# Или можно переопределить команду:
docker run otus-qajs npm run test:ci
```

### Способ 2: Запуск с монтированием локальных файлов
Этот способ удобен для локальной разработки. Код остается на вашей машине, а выполняется в контейнере.

```bash
# -v монтирует текущую директорию ($(pwd)) в /app внутри контейнера
# -it запускает контейнер в интерактивном режиме с терминалом
docker run -v "$(pwd):/app" -it node:20 bash

# Внутри контейнера:
npm ci
npm test
exit
```

> **Проблема с `node_modules`**: При монтировании тома папка `node_modules` с хоста может перезаписать ту, что внутри контейнера. Решение — использовать анонимный том для `node_modules`, чтобы изолировать ее от хоста: `docker run -v "$(pwd):/app" -v /app/node_modules -it node:20 bash`

## Оптимизация и лучшие практики

-   **Использование `.dockerignore`**: Создайте файл `.dockerignore` в корне проекта, чтобы исключить ненужные файлы и папки (например, `node_modules`, `.git`, `reports`) из контекста сборки. Это ускоряет сборку и уменьшает размер образа.
-   **Выбор базового образа**: Образы `node:slim` и `node:alpine` значительно меньше стандартного `node`, что экономит место на диске, но они могут не содержать некоторых системных утилит.
-   **Управление ресурсами**: При запуске контейнера можно ограничить потребление CPU и памяти:
    ```bash
    docker run --memory=1g --cpus=2 otus-qajs
    ```
-   **Makefile**: Для упрощения длинных Docker-команд можно использовать `Makefile` для создания коротких псевдонимов (например, `make test_run`).

## Установка Docker

Для Windows и macOS рекомендуется устанавливать **Docker Desktop** с официального сайта.

-   [Docker Desktop](https://www.docker.com/products/docker-desktop/)

## Полезные ресурсы
-   **Дока**: [Что такое Docker](https://doka.guide/tools/docker/)
-   **Docker Docs**: [Официальная документация](https://docs.docker.com/)
-   **Node.js Best Practices**: [Раздел про Docker](https://github.com/goldbergyoni/nodebestpractices/blob/master/sections/docker/README.md)