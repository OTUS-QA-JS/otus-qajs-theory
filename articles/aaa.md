# Паттерн Arrange, Act и Assert (AAA) в автоматизации юнит-тестирования

[Оригинал на английском](https://semaphore.io/blog/aaa-pattern-test-automation)
[Альтеративный перевод от testengineer.ru](https://testengineer.ru/aaa-pattern/)

Вот перевод статьи «The Arrange, Act, and Assert (AAA) Pattern in Unit Test Automation» на русский язык в формате Markdown.

---

Одной из самых сложных задач при написании надежных, последовательных, поддерживаемых и легко читаемых тестов является их правильное структурирование. Несоблюдение определенной структуры в каждом юнит-тесте может привести к нестабильным или ненадежным тестам — кошмару любого QA-разработчика.

За годы работы появилось множество подходов к юнит-тестированию, среди которых наиболее популярным стал паттерн **Arrange-Act-Assert (AAA или 3A)**. Этот паттерн предполагает разделение юнит-теста на три этапа:

1. **Arrange (Подготовка):** Настройка тестовой среды.
2. **Act (Действие):** Выполнение тестируемого кода.
3. **Assert (Проверка):** Верификация результатов.

В этом руководстве вы узнаете, что такое паттерн AAA, как он работает, какие преимущества дает и какую роль играет в автоматизации юнит-тестирования.

## Паттерн AAA в юнит-тестировании

Паттерн Arrange-Act-Assert (AAA) — это широко признанный подход к структурированию тестов. Впервые он был предложен Биллом Вейком в 2001 году, а затем упомянут в знаковой книге Кента Бека «Разработка через тестирование: на примерах» (Test Driven Development: By Example) в 2002 году.

Паттерн AAA способствует ясности, рекомендуя структурировать тесты по трем различным фазам:

* **Подготовка (Arrange)** всего необходимого для проведения теста.
* **Действие (Act)** над целевым кодом путем его выполнения.
* **Проверка (Assert)** ожидаемых результатов.

Структура AAA повышает читаемость и удобство сопровождения, тесно перекликаясь со структурой **Given-When-Then**, разработанной Дэниелом Терхорстом-Нортом и Крисом Мэттсом в рамках BDD (Behavior-Driven Development). Сегодня почти все современные инструменты тестирования с синтаксисом BDD поощряют использование паттерна AAA.

### 1. Arrange (Подготовка)

На этапе подготовки вы создаете все условия, необходимые для выполнения теста, чтобы гарантировать точность результатов. Это включает инициализацию объектов, настройку зависимостей и окружения.

Примеры операций на этом этапе:

* Создание экземпляров тестируемых классов.
* Инициализация переменных конкретными значениями.
* Настройка мок-объектов (mocks) для имитации внешних сервисов.
* Заполнение базы данных тестовыми данными.

Тщательная подготовка гарантирует, что последующие действия и проверки пройдут в контролируемой и предсказуемой среде, что снижает вероятность «флакующих» (нестабильных) тестов.

### 2. Act (Действие)

На этапе действия вы выполняете конкретную функциональность, которую хотите протестировать. Вы взаимодействуете с SUT (System Under Test — тестируемая система), вызывая метод или функцию.

В большинстве юнит-тестов этот этап сводится к вызову метода объекта. Чтобы тест оставался читаемым, это действие должно быть кратким и сфокусированным. Обычно достаточно одной строки кода.

### 3. Assert (Проверка)

На этапе проверки вы подтверждаете, что результат юнит-теста соответствует вашим ожиданиям. Вы сравниваете фактические значения, полученные на этапе Act, с ожидаемыми.

Обычно это делается с помощью методов утверждения (assertions). Примеры:

* Проверка того, что метод вернул правильное значение.
* Проверка изменения состояния объекта.
* Гарантия того, что при определенных условиях выбрасывается исключение.

Рекомендуется использовать одно утверждение (или небольшой набор связанных утверждений) на один юнит-тест.

---

## Пример юнит-теста в стиле AAA

Рассмотрим пример юнит-теста на Mocha (JavaScript), организованного по паттерну AAA:

```javascript
import { expect } from "chai"
import { MathUtils } from "src/utils/MathUtils";

describe("MathUtils Tests", function () {
  describe("#getFibonacciNumber()", function () {
    it("should return the correct Fibonacci number", function () {
      // Arrange: Инициализация класса для теста
      const mathUtils = new MathUtils()

      // Act: Тестирование метода класса
      const result = mathUtils.getFibonacciNumber(6)

      // Assert: Проверка соответствия результата ожиданиям
      expect(result).to.equal(8)
    })
  })
})

```

### Разбор этапов:

* **Arrange:** `const mathUtils = new MathUtils()` — создаем экземпляр класса. Если настройка сложная (например, БД), она может быть вынесена в хуки `beforeEach()`.
* **Act:** `const result = mathUtils.getFibonacciNumber(6)` — вызываем метод с входными данными.
* **Assert:** `expect(result).to.equal(8)` — проверяем результат с помощью библиотеки Chai.

---

## 7 причин использовать паттерн AAA

1. **Независимость от языка и фреймворка.** Паттерн можно применять в Mocha, Jest (JS), JUnit (Java), pytest (Python) и любых других инструментах.
2. **Лучшая организация кода.** Четкое разделение на три фазы поддерживает единообразие во всем проекте.
3. **Простота понимания.** Даже если разработчик не знаком с конкретным инструментом, структура теста остается интуитивно понятной.
4. **Поддержка TDD.** Структура AAA идеально ложится в концепцию Test-Driven Development, позволяя четко определить ожидаемое поведение до написания кода.
5. **Упрощение рефакторинга.** Если меняется способ вызова метода, вам нужно обновить только фазу **Act**, не затрагивая **Arrange** или **Assert**.
6. **Разделение ответственности.** Каждая фаза сфокусирована на своей задаче (подготовка, выполнение или проверка), что делает тесты модульными.
7. **Соответствие отраслевым стандартам.** AAA упоминается в [лучших практиках Node.js](https://github.com/goldbergyoni/javascript-testing-best-practices/blob/master/readme-ru.md#-%EF%B8%8F-12-разделите-тесты-по-aaa-структуре), документации Visual Studio, [Cypress](https://learn.cypress.io/testing-foundations) и Pytest.

---

## Роль AAA в автоматизации тестирования

Структурированный подход играет ключевую роль в CI/CD пайплайнах. Благодаря этапу **Assert**, результаты тестов в логах становятся легче для анализа.

Если тест падает, структура AAA позволяет быстро локализовать проблему. Например, если данные в фазах Arrange и Act верны, но тест упал, проблема, скорее всего, либо в логике Assert (ошибка в ожидаемом значении), либо непосредственно в самом коде SUT.

Это ускоряет процесс исправления ошибок и повышает общую стабильность процесса разработки.

## Заключение

Паттерн Arrange-Act-Assert (AAA) — это стандарт де-факто для написания читаемых и поддерживаемых юнит-тестов. Разделяя тесты на три логических этапа, команды разработчиков и QA-инженеров могут создавать надежную базу тестов, которая служит документацией и гарантией качества программного обеспечения.